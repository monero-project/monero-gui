name: Flatpak

on:
  release:
    types: released

jobs:
  build:
    name: org.getmonero.Monero
    if: github.repository == 'monero-project/monero-gui'
    strategy:
      matrix:
        arch: [x86_64, aarch64]
        include:
          - arch: x86_64
            runner: ubuntu-24.04
          - arch: aarch64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:kde-5.15-24.08
      options: --privileged
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Add version and date
      run: |
        sed -i 's/<version>/${{ github.event.release.tag_name }}/g' $GITHUB_WORKSPACE/share/org.getmonero.Monero.metainfo.xml
        sed -i 's/<date>/'"$(date '+%F')"'/g' $GITHUB_WORKSPACE/share/org.getmonero.Monero.metainfo.xml

    - name: Validate Flatpak manifest
      run: flatpak-builder-lint manifest share/org.getmonero.Monero.yaml

    - name: Build flatpak
      uses: flathub-infra/flatpak-github-actions/flatpak-builder@821846071bc503ec98c1db6b75530b571606e1a5
      env:
        FLATPAK_BUILDER_N_JOBS: 3
      with:
        manifest-path: share/org.getmonero.Monero.yaml
        arch: ${{ matrix.arch }}
        cache: false
        branch: stable
        mirror-screenshots-url: https://dl.flathub.org/media

    - name: Validate AppStream
      run: flatpak-builder-lint appstream flatpak_app/files/share/metainfo/org.getmonero.Monero.metainfo.xml

    - name: Verify Icon and Metadata in app-info
      run: |
        test -f flatpak_app/files/share/app-info/icons/flatpak/128x128/org.getmonero.Monero.png || { echo "::error::Missing 128x128 icon in app-info"; exit 1; }
        test -f flatpak_app/files/share/app-info/xmls/org.getmonero.Monero.xml.gz || { echo "::error::Missing org.getmonero.Monero.xml.gz in app-info"; exit 1; }

    - name: Validate build directory
      run: flatpak-builder-lint builddir flatpak_app

    - name: Validate repository
      run: flatpak-builder-lint repo repo

    - name: Print hashes
      working-directory: flatpak_app/files/bin
      run: |
        echo "Hashes of the ${{ matrix.arch }} binaries:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        for bin in monero-blockchain-ancestry monero-blockchain-depth monero-blockchain-export monero-blockchain-import monero-blockchain-mark-spent-outputs monero-blockchain-prune monero-blockchain-prune-known-spent-data monero-blockchain-stats monero-blockchain-usage monerod monero-gen-ssl-cert monero-gen-trusted-multisig monero-wallet-cli monero-wallet-gui monero-wallet-rpc p2pool; do sha256sum $bin; done >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "An example command to check hashes:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "$ flatpak run --command=sha256sum org.getmonero.Monero /app/bin/monero-wallet-gui" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Publish to Flathub
      uses: flathub-infra/flatpak-github-actions/flat-manager@6d0dd363260c9917f0bca469ec21370bb45a5b9f
      with:
        flat-manager-url: https://hub.flathub.org
        repository: stable
        build-log-url: https://github.com/monero-project/monero-gui/actions/runs/${{ github.run_id }}
        token: ${{ secrets.FLATHUB_TOKEN }}
