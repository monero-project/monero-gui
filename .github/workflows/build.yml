name: ci/gh-actions/gui

on: [push, pull_request]

env:
  FREE_DISKSPACE: |
    sudo rm -rf /usr/local/.ghcup /usr/share/dotnet /usr/share/swift /usr/share/miniconda
  QT_TAG: v6.7.0
  QT_VERSION: 6.7.0
  QT_PREFIX: ${{ github.workspace }}/qt-install

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: install dependencies
      run: HOMEBREW_NO_AUTO_UPDATE=1 brew install boost hidapi openssl zmq libpgm libsodium miniupnpc expat libunwind-headers protobuf qt6 pkg-config icu4c abseil
    - name: build
      run: DEV_MODE=ON CMAKE_PREFIX_PATH="/opt/homebrew/opt/qt6;/opt/homebrew/opt/icu4c;/opt/homebrew/opt/abseil" make release -j3
    - name: test qml
      run: build/release/bin/monero-wallet-gui.app/Contents/MacOS/monero-wallet-gui --test-qml

  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: remove bundled boost
      run: sudo rm -rf /usr/local/share/boost
    - name: set apt conf
      run: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
    - name: update apt
      run: sudo apt update
    - name: install monero dependencies
      run: sudo apt -y install build-essential cmake libboost-all-dev miniupnpc libunbound-dev graphviz doxygen libunwind8-dev pkg-config libssl-dev libzmq3-dev libsodium-dev libhidapi-dev libnorm-dev libusb-1.0-0-dev libpgm-dev libprotobuf-dev protobuf-compiler
    - name: install monero gui dependencies
      run: sudo apt -y install qt6-base-dev qt6-declarative-dev qt6-tools-dev qt6-tools-dev-tools qt6-l10n-tools qml6-module-qtquick qml6-module-qtquick-controls qml6-module-qtquick-dialogs qml6-module-qtquick-templates qml6-module-qt-labs-platform qml6-module-qt-labs-folderlistmodel qml6-module-qt-labs-settings qml6-module-qtqml-models libqt6svg6-dev libqt6core5compat6-dev libgcrypt20-dev xvfb
    - name: build
      run: DEV_MODE=ON make release -j3
    - name: test qml
      run: xvfb-run -a build/release/bin/monero-wallet-gui --test-qml

  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - uses: eine/setup-msys2@v2
      with:
        update: true
        install: mingw-w64-x86_64-toolchain make mingw-w64-x86_64-pcre mingw-w64-x86_64-cmake mingw-w64-x86_64-boost mingw-w64-x86_64-openssl mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium mingw-w64-x86_64-hidapi mingw-w64-x86_64-protobuf-c mingw-w64-x86_64-libusb mingw-w64-x86_64-unbound git mingw-w64-x86_64-qt6 mingw-w64-x86_64-qt6-base mingw-w64-x86_64-qt6-declarative mingw-w64-x86_64-qt6-tools mingw-w64-x86_64-qt6-svg mingw-w64-x86_64-qt6-5compat mingw-w64-x86_64-libgcrypt mingw-w64-x86_64-angleproject
    - name: build
      run: DEV_MODE=ON make release-win64 -j2
    - name: deploy
      run: make deploy
      working-directory: build/release
    - name: test qml
      run: build/release/bin/monero-wallet-gui --test-qml

  macos-bundle:
    runs-on: macos-15
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: install dependencies
      run: HOMEBREW_NO_AUTO_UPDATE=1 brew install boost hidapi openssl zmq libpgm miniupnpc expat libunwind-headers protobuf pkg-config ninja cmake icu4c abseil
    - name: clone qt6 repos
      run: |
        set -e
        mkdir -p qt6
        cd qt6
        repos=(
          qtbase
          qtdeclarative
          qt5compat
          qtimageformats
          qtmultimedia
          qtquickcontrols
          qtsvg
          qttools
          qttranslations
        )
        for repo in "${repos[@]}"; do
          url="https://code.qt.io/qt/${repo}.git"
          echo "Cloning ${repo}..."
          # Try fast path: clone the tag/branch directly
          if git clone --depth 1 --branch "${QT_TAG}" "${url}"; then
            echo "Cloned ${repo} at ${QT_TAG} (direct)"
            continue
          fi
          # Fallback: clone default branch (not shallow), fetch tags and try several tag name forms
          echo "Direct clone failed for ${repo}, cloning default branch and fetching tag ${QT_TAG}..."
          if git clone "${url}"; then
            cd "${repo}"
            # ensure we have tag objects
            git fetch --tags --prune origin || true
            # collect candidate tag names: exact QT_TAG, QT_VERSION variants, plus any remote tags containing the version
            tried_tags=("${QT_TAG}")
            if [[ "${QT_TAG}" = v* ]]; then
              tried_tags+=("${QT_TAG#v}")
            else
              tried_tags+=("v${QT_TAG}")
            fi
            tried_tags+=("${QT_VERSION}")
            tried_tags+=("v${QT_VERSION}")
            # add any remote tags that contain the QT_VERSION (e.g. v6.7.0-rc1)
            while read -r tag; do
              tried_tags+=("$tag")
            done < <(git ls-remote --tags --refs origin | awk -F/ '{print $NF}' | grep -E "${QT_VERSION}" || true)
            # deduplicate candidates and try to resolve each to a commit (handle annotated tags)
            declare -A seen=()
            found=0
            for t in "${tried_tags[@]}"; do
              if [[ -z "${t}" ]] || [[ -n "${seen[$t]}" ]]; then
                continue
              fi
              seen[$t]=1
              if commit_sha=$(git rev-parse --verify --quiet "refs/tags/${t}^{commit}"); then
                git checkout -b "${t}" "${commit_sha}" && found=1 && break
              elif commit_sha=$(git rev-parse --verify --quiet "refs/tags/${t}"); then
                git checkout -b "${t}" "${commit_sha}" && found=1 && break
              fi
            done
            if [ "${found}" -ne 1 ]; then
              echo "Tag ${QT_TAG} (or alternate forms) not found in ${repo}"
              exit 1
            fi
            cd ..
          else
            echo "Failed to clone ${repo} repository"
            exit 1
          fi
        done
    - name: build qt6 from source
      run: |
        set -e
        cd qt6/qtbase
        mkdir build && cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${QT_PREFIX}" \
          -DFEATURE_openssl=ON -DFEATURE_sql_sqlite=OFF -DFEATURE_dbus=OFF \
          -DQT_BUILD_EXAMPLES=OFF -DQT_BUILD_TESTS=OFF -DQT_BUILD_TOOLS=ON \
          -DQT_FEATURE_opengl=ON -DQT_FEATURE_opengl_desktop=ON \
          ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
        cd ../../qtdeclarative && mkdir build && cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${QT_PREFIX}" \
          -DCMAKE_PREFIX_PATH="${QT_PREFIX}" ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
        cd ../../qt5compat && mkdir build && cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${QT_PREFIX}" \
          -DCMAKE_PREFIX_PATH="${QT_PREFIX}" ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
        cd ../../qtsvg && mkdir build && cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${QT_PREFIX}" \
          -DCMAKE_PREFIX_PATH="${QT_PREFIX}" ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
        cd ../../qtquickcontrols && mkdir build && cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${QT_PREFIX}" \
          -DCMAKE_PREFIX_PATH="${QT_PREFIX}" ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
        cd ../../qttools && mkdir build && cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${QT_PREFIX}" \
          -DCMAKE_PREFIX_PATH="${QT_PREFIX}" \
          -DFEATURE_linguist=ON -DFEATURE_lrelease=ON ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
    - name: build monero-gui
      run: |
        set -e
        mkdir build && cd build
        cmake -G Ninja -D CMAKE_BUILD_TYPE=Release -D ARCH=default -D CMAKE_PREFIX_PATH="${QT_PREFIX}" ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
    - name: deploy
      run: cmake --build . --target deploy
      working-directory: build
    - name: test qml
      run: build/bin/monero-wallet-gui.app/Contents/MacOS/monero-wallet-gui --test-qml
    - name: create .tar
      run: tar -cf monero-wallet-gui.tar monero-wallet-gui.app
      working-directory: build/bin
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}
        path: build/bin/monero-wallet-gui.tar

  docker-linux-static:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: install dependencies
      run: sudo apt -y install xvfb libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xkb1 libxcb-shape0 libxkbcommon-x11-0
    - name: free up diskspace
      run: ${{env.FREE_DISKSPACE}}
    - name: prepare build environment
      run: |
        docker build --tag monero:build-env-linux \
          --build-arg THREADS=3 \
          --build-arg QT_VERSION=${{ env.QT_VERSION }} \
          --file Dockerfile.linux .
    - name: build
      run: docker run --rm -v /home/runner/work/monero-gui/monero-gui:/monero-gui -w /monero-gui monero:build-env-linux sh -c 'make release-static -j3'
    - name: sha256sum
      run: shasum -a256 /home/runner/work/monero-gui/monero-gui/build/release/bin/monero-wallet-gui
    - name: test qml
      run: xvfb-run -a /home/runner/work/monero-gui/monero-gui/build/release/bin/monero-wallet-gui --test-qml
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}
        path: |
          /home/runner/work/monero-gui/monero-gui/build/release/bin/monero-wallet-gui
          /home/runner/work/monero-gui/monero-gui/build/release/bin/monerod

  docker-windows-static:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: free up diskspace
      run: ${{env.FREE_DISKSPACE}}
    - name: prepare build environment
      run: |
        docker build --tag monero:build-env-windows \
          --build-arg THREADS=3 \
          --build-arg QT_VERSION=${{ env.QT_VERSION }} \
          --file Dockerfile.windows .
    - name: build
      run: docker run --rm -v /home/runner/work/monero-gui/monero-gui:/monero-gui -w /monero-gui monero:build-env-windows sh -c 'make depends root=/depends target=x86_64-w64-mingw32 tag=win-x64 -j3'
    - name: sha256sum
      run: shasum -a256 /home/runner/work/monero-gui/monero-gui/build/x86_64-w64-mingw32/release/bin/monero-wallet-gui.exe
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}
        path: |
          /home/runner/work/monero-gui/monero-gui/build/x86_64-w64-mingw32/release/bin/monero-wallet-gui.exe
          /home/runner/work/monero-gui/monero-gui/build/x86_64-w64-mingw32/release/bin/monerod.exe

  docker-android:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: free up diskspace
      run: ${{env.FREE_DISKSPACE}}
    - name: prepare build environment
      run: |
        docker build --tag monero:build-env-android \
          --build-arg THREADS=3 \
          --build-arg QT_VERSION=${{ env.QT_VERSION }} \
          --file Dockerfile.android .
    - name: build
      run: docker run --rm -v /home/runner/work/monero-gui/monero-gui:/monero-gui -e THREADS=3 monero:build-env-android
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}
        path: /home/runner/work/monero-gui/monero-gui/build/Android/release/android-build/monero-gui.apk

  source-archive:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: recursive
    - name: archive
      run: |
        pip install git-archive-all
        export VERSION="monero-gui-$(git describe)"
        export OUTPUT="$VERSION.tar"
        echo "OUTPUT=$OUTPUT" >> $GITHUB_ENV
        /home/runner/.local/bin/git-archive-all --prefix "$VERSION/" --force-submodules "$OUTPUT"
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT }}
        path: /home/runner/work/monero-gui/monero-gui/${{ env.OUTPUT }}
